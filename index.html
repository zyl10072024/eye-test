<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>精密实验视力表 - 自动保存版</title>
    <style>
        * { box-sizing: border-box; }
        body { background: #000; color: #fff; margin: 0; font-family: -apple-system, sans-serif; overflow: hidden; }
        
        #setup { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a1a; z-index: 1000; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; padding: 10px; overflow-y: auto;
        }
        .controls { background: #2c2c2c; padding: 20px; border-radius: 20px; margin-bottom: 20px; width: 100%; max-width: 450px; text-align: center; }
        #calib-box { width: 10mm; height: 10mm; background: #fff; margin: 15px auto; border: 1px solid #007AFF; }
        
        .input-group { margin: 10px 0; display: flex; align-items: center; justify-content: space-between; gap: 10px; font-size: 14px; }
        .input-group input { 
            width: 100px; background: #444; border: 1px solid #666; color: #fff; 
            padding: 5px; border-radius: 5px; text-align: center;
        }
        
        .pixel-step { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        button { padding: 12px 24px; background: #007AFF; color: #fff; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
        button.step-btn { background: #444; padding: 6px 12px; font-size: 12px; }
        
        #chart { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            display: none; flex-direction: column-reverse; align-items: center; 
        }
        .snellen-e {
            background: #fff;
            -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 5 5"><path d="M0 0h5v1H1v1h3v1H1v1h4v1H0z"/></svg>');
            mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 5 5"><path d="M0 0h5v1H1v1h3v1H1v1h4v1H0z"/></svg>');
            mask-repeat: no-repeat;
        }
    </style>
</head>
<body>

<div id="setup">
    <div class="controls">
        <div id="calib-box"></div>
        
        <div class="input-group">
            <span>物理比例系数:</span>
            <input type="number" id="manual-ratio" step="0.0001">
        </div>

        <div class="pixel-step">
            <button class="step-btn" onclick="adjustByPixel(-1)">-1 像素</button>
            <button class="step-btn" onclick="adjustByPixel(1)">+1 像素</button>
        </div>

        <hr style="border: 0; border-top: 1px solid #444; margin: 15px 0;">

        <div class="input-group">
            <span>底部边距 (px):</span>
            <input type="number" id="bottom-offset">
        </div>
        <div class="input-group">
            <span>E字行间距 (px):</span>
            <input type="number" id="row-gap">
        </div>
        <p style="font-size: 11px; color: #888; margin-top: 10px;">
            设置已自动保存，刷新后不会丢失
        </p>
    </div>
    <button onclick="launchChart()" style="width:100%; max-width:450px;">进入全屏实验</button>
</div>

<div id="chart" onclick="location.reload()"></div>

<script>
    const basePxPerMm = 3.7795275591; 
    
    const manualRatio = document.getElementById('manual-ratio');
    const bottomOffsetInput = document.getElementById('bottom-offset');
    const rowGapInput = document.getElementById('row-gap');
    const calibBox = document.getElementById('calib-box');

    // --- 自动加载逻辑 ---
    window.onload = () => {
        manualRatio.value = localStorage.getItem('manualRatio') || "1.0000";
        bottomOffsetInput.value = localStorage.getItem('bottomOffset') || "80";
        rowGapInput.value = localStorage.getItem('rowGap') || "30";
        updateCalibBox();
    };

    // --- 自动保存逻辑 ---
    function saveData() {
        localStorage.setItem('manualRatio', manualRatio.value);
        localStorage.setItem('bottomOffset', bottomOffsetInput.value);
        localStorage.setItem('rowGap', rowGapInput.value);
    }

    function updateCalibBox() {
        calibBox.style.transform = `scale(${manualRatio.value})`;
        saveData();
    }

    manualRatio.oninput = updateCalibBox;
    bottomOffsetInput.oninput = saveData;
    rowGapInput.oninput = saveData;

    function adjustByPixel(direction) {
        const pixelDelta = 1 / (10 * basePxPerMm);
        let val = parseFloat(manualRatio.value);
        val += (direction * pixelDelta);
        manualRatio.value = val.toFixed(4);
        updateCalibBox();
    }

    function launchChart() {
        saveData(); // 启动前最后保存一次
        if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen();
        }
        document.getElementById('setup').style.display = 'none';
        const chartDiv = document.getElementById('chart');
        chartDiv.style.display = 'flex';
        renderSnellen();
    }

    function renderSnellen() {
        const chartDiv = document.getElementById('chart');
        chartDiv.innerHTML = ''; // 清空之前的内容
        const scale = parseFloat(manualRatio.value);
        const bottomOffset = parseFloat(bottomOffsetInput.value);
        const rowGap = parseFloat(rowGapInput.value);
        
        const distMm = 500; 
        const snellenLevels = [6, 10, 12, 15, 20, 30, 60]; 

        chartDiv.style.paddingBottom = `${bottomOffset}px`;

        snellenLevels.forEach((denom, index) => {
            const h = distMm * Math.tan((denom / 6 * 5 / 60) * Math.PI / 180) * basePxPerMm * scale;
            
            const eImg = document.createElement('div');
            eImg.className = 'snellen-e';
            eImg.style.width = `${h}px`;
            eImg.style.height = `${h}px`;
            eImg.style.flexShrink = "0";

            if (index > 0) {
                eImg.style.marginBottom = `${rowGap}px`;
            }

            chartDiv.appendChild(eImg);
        });
    }
</script>
</body>
</html>
